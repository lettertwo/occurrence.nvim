name: Conventional Commits

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: write
  statuses: write

jobs:
  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches

      - name: Validate PR Title
        if: github.event_name == 'pull_request'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Conventional Commits regex pattern
          PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?: .{1,72}$'

          echo "Validating PR title: $PR_TITLE"

          if echo "$PR_TITLE" | grep -qE "$PATTERN"; then
            echo "✓ PR title follows Conventional Commits format"
          else
            echo "✗ PR title does not follow Conventional Commits format"
            echo ""
            echo "Expected format: <type>(<scope>): <subject>"
            echo ""
            echo "Examples:"
            echo "  feat: add new feature"
            echo "  fix(api): resolve bug in API"
            echo "  docs: update README"
            echo ""
            echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
            exit 1
          fi

      - name: Validate All Commits in PR
        if: github.event_name == 'pull_request'
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          # Conventional Commits regex pattern
          PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?: .+'

          echo "Validating commits in range: $BASE_SHA..$HEAD_SHA"
          echo ""

          INVALID_COMMITS=()

          # Get all commit messages in the PR
          while IFS= read -r commit_sha; do
            commit_msg=$(git log -1 --format=%s "$commit_sha")

            if echo "$commit_msg" | grep -qE "$PATTERN"; then
              echo "✓ $commit_sha: $commit_msg"
            else
              echo "✗ $commit_sha: $commit_msg"
              INVALID_COMMITS+=("$commit_sha: $commit_msg")
            fi
          done < <(git rev-list "$BASE_SHA..$HEAD_SHA")

          echo ""

          if [ ${#INVALID_COMMITS[@]} -gt 0 ]; then
            echo "❌ Found ${#INVALID_COMMITS[@]} commit(s) that don't follow Conventional Commits:"
            echo ""
            for commit in "${INVALID_COMMITS[@]}"; do
              echo "  - $commit"
            done
            echo ""
            echo "Please update commit messages to follow the Conventional Commits format:"
            echo "  <type>(<scope>): <subject>"
            echo ""
            echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
            echo ""
            echo "Examples:"
            echo "  feat: add new feature"
            echo "  fix(api): resolve bug in API"
            echo "  docs: update README"
            echo "  refactor(keymap)!: breaking change to keymap"
            echo ""
            echo "See CONTRIBUTING.md for more details."
            exit 1
          else
            echo "✅ All commits follow Conventional Commits format!"
          fi

      - name: Add Comment on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ❌ Conventional Commits Validation Failed

            Your PR title or commit messages don't follow the [Conventional Commits](https://www.conventionalcommits.org/) specification.

            ### Required Format
            \`\`\`
            <type>(<scope>): <subject>
            \`\`\`

            ### Valid Types
            - **feat**: A new feature
            - **fix**: A bug fix
            - **docs**: Documentation changes
            - **style**: Code style changes (formatting, etc)
            - **refactor**: Code refactoring
            - **perf**: Performance improvements
            - **test**: Adding or updating tests
            - **build**: Build system changes
            - **ci**: CI configuration changes
            - **chore**: Other changes
            - **revert**: Revert a previous commit

            ### Examples
            \`\`\`
            feat: add new operator
            fix(api): prevent buffer errors
            docs: update configuration examples
            refactor(keymap)!: simplify API (breaking change)
            \`\`\`

            ### Using the Commit Template
            To help write valid commits, configure the git commit template:
            \`\`\`bash
            git config commit.template .gitmessage
            \`\`\`

            See [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md) for more details.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
